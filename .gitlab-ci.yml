stages:
  - lint
  - create-tag
  - release

include:
  - component: $CI_SERVER_HOST/buildtools/gitlab-tools/lint-helm@main
  - component: $CI_SERVER_HOST/buildtools/gitlab-tools/release-helm-oci@main
  - component: $CI_SERVER_HOST/buildtools/gitlab-tools/release-helm-oci-gitlabcom@main

before_script:
  # start: fix gitlab-ci's umask 0000 issue
  - umask 0022
  - find . ! -path . ! -path './.git' ! -path './.git/*' -exec chmod go-w {} +
  # end: fix gitlab-ci's umask 0000 issue

create-tag:
  stage: create-tag
  image: $CI_REGISTRY/buildtools/gitlab-tools:latest
  script:
    - create-tag-from-head --tag "v$(grep '^version:' Chart.yaml | awk '{print $2}')"
  only:
    - master
