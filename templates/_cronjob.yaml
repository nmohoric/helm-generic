{{/*
Overlay cronjob spec overlay
*/}}
{{- define "helm-generic.cronjob-spec-overlay" -}}
jobTemplate:
  spec:
    template:
      metadata:
        {{- with .Values.podAnnotations }}
        annotations:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        labels:
          {{- include "helm-generic.selectorLabels" . | nindent 10 }}
          {{- include "helm-generic.commonLabels" . | nindent 10 }}
          {{- with .Values.podLabels }}
          {{- toYaml . | nindent 10 }}
          {{- end }}
{{- end -}}

{{/*
Generate the cronjob yaml resource
*/}}
{{- define "helm-generic.cronjob-spec" -}}
{{- $root := .root -}}
{{- $resource := deepCopy .spec -}}
{{- $_ := set $resource "spec" (mustMerge $resource.spec (include "helm-generic.cronjob-spec-overlay" $root | fromYaml)) -}}

{{- $includeRootPodSpec := dict "root" $root "spec" $resource.spec.jobTemplate.spec.template -}}
{{- $podSpec := (include "helm-generic.pod-spec" $includeRootPodSpec | fromYaml) -}}
{{- $_ := unset $resource.spec.jobTemplate.spec.template.spec "initContainers" -}}
{{- $_ := unset $resource.spec.jobTemplate.spec.template.spec "containers" -}}
{{- $_ := set $resource.spec.jobTemplate.spec.template "spec" (mustMerge $resource.spec.jobTemplate.spec.template.spec $podSpec) -}}
{{- $spec := $resource.spec -}}

{{- tpl (toYaml $spec) $root }}
{{- end }}
