{{/*
Overlay pod spec overlay
*/}}
{{- define "helm-generic.pod-spec-overlay" -}}
{{- with .Values.imagePullSecrets }}
imagePullSecrets:
  {{- toYaml . | nindent 8 }}
{{- end }}
serviceAccountName: {{ include "helm-generic.serviceAccountName" . }}
{{- end -}}

{{/*
Pod image name
*/}}
{{- define "helm-generic.pod-image-name" -}}
{{ .Values.image.repository }}:{{ .Values.image.tag | default "latest" }}
{{- end -}}

{{/*
Pod container template
*/}}
{{- define "helm-generic.pod-container" -}}
{{- $root := .root -}}
{{- $container := .container -}}

{{- if not (hasKey $container "image") -}}
{{- $_ := set $container "image" (include "helm-generic.pod-image-name" $root) -}}
{{- end -}}
{{- if not (hasKey $container "imagePullPolicy") -}}
{{- $_ := set $container "imagePullPolicy" (default $root.Values.image.pullPolicy $container.imagePullPolicy) -}}
{{- end -}}

{{- tpl (toYaml $container) $root }}
{{- end -}}

{{/*
Overlay pod spec overlay
*/}}
{{- define "helm-generic.pod-containers" -}}
{{- $root := .root -}}
{{- $spec := .spec -}}
containers:
{{- range $index, $container := $spec.containers }}
  - # placeholder for container {{ $index }}
    {{- include "helm-generic.pod-container" (dict "root" $root "container" $container) | fromYaml | toYaml | nindent 4 }}
{{- end }}
{{- end -}}

{{/*
Generate the pod yaml resource
*/}}
{{- define "helm-generic.pod-spec" -}}
{{- $root := .root -}}
{{- $resource := deepCopy .spec -}}
{{- $_ := set $resource "spec" (merge $resource.spec (include "helm-generic.pod-spec-overlay" $root | fromYaml)) -}}
{{- $includeRootContainers := dict "root" $root "spec" (deepCopy $resource.spec) -}}
{{- $spec := $resource.spec -}}
{{- $_ := unset $spec "containers" -}}
{{- $containers := (include "helm-generic.pod-containers" $includeRootContainers | fromYaml) -}}
{{- $spec := mergeOverwrite $spec $containers -}}

{{- tpl (toYaml $spec) $root }}
{{- end }}
