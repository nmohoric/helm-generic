{{/*
Overlay pod spec overlay
*/}}
{{- define "helm-generic.pod-spec-overlay" -}}
{{- with .Values.imagePullSecrets }}
imagePullSecrets:
  {{- toYaml . | nindent 8 }}
{{- end }}
serviceAccountName: {{ include "helm-generic.serviceAccountName" . }}
{{- end -}}

{{/*
Pod image name
*/}}
{{- define "helm-generic.pod-image-name" -}}
{{ .Values.image.repository }}:{{ .Values.image.tag | default "latest" }}
{{- end -}}

{{/*
Pod container template
*/}}
{{- define "helm-generic.pod-container" -}}
{{- $root := .root -}}
{{- $container := .container -}}
{{- $name := .name -}}

{{- if and $name (not (hasKey $container "name")) -}}
{{- $_ := set $container "name" $name -}}
{{- end -}}
{{- if not (hasKey $container "image") -}}
{{- $_ := set $container "image" (include "helm-generic.pod-image-name" $root) -}}
{{- end -}}
{{- if not (hasKey $container "imagePullPolicy") -}}
{{- $_ := set $container "imagePullPolicy" (default $root.Values.image.pullPolicy $container.imagePullPolicy) -}}
{{- end -}}

{{- tpl (toYaml $container) $root }}
{{- end -}}

{{/*
Overlay container spec overlay
*/}}
{{- define "helm-generic.pod-containers" -}}
{{- $root := .root -}}
{{- $spec := .spec -}}
{{- $key := .key -}}
{{- $containers := (get $spec $key) -}}

{{ $key }}:
{{- if kindIs "map" $containers -}}
{{- range $name, $container := $containers }}
  - # placeholder for container {{ $name }}
    {{- include "helm-generic.pod-container" (dict "root" $root "container" $container "name" $name) | fromYaml | toYaml | nindent 4 }}
{{- end }}
{{- else -}}
{{- range $index, $container := $containers }}
  - # placeholder for container {{ $index }}
    {{- include "helm-generic.pod-container" (dict "root" $root "container" $container) | fromYaml | toYaml | nindent 4 }}
{{- end }}
{{- end -}}
{{- end -}}

{{/*
Generate the pod yaml resource
*/}}
{{- define "helm-generic.pod-spec" -}}
{{- $root := .root -}}
{{- $resource := deepCopy .spec -}}
{{- $_ := set $resource "spec" (merge $resource.spec (include "helm-generic.pod-spec-overlay" $root | fromYaml)) -}}
{{- $specCopy := deepCopy $resource.spec -}}
{{- $spec := $resource.spec -}}

{{- range $key := tuple "initContainers" "containers" -}}
{{- if hasKey $spec $key -}}
{{- $_ := unset $spec $key -}}
{{- $containers := (include "helm-generic.pod-containers" (dict "root" $root "spec" $specCopy "key" $key) | fromYaml) -}}
{{- $spec := mergeOverwrite $spec $containers -}}
{{- end }}
{{- end -}}

{{- tpl (toYaml $spec) $root }}
{{- end }}
